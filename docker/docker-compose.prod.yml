# Docker Compose Production Override
# Use with: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  app:
    # Production image settings
    image: stock-sentiment-analyzer:latest
    
    # Remove env_file and use environment variables instead
    env_file: []
    environment:
      # Environment variables should be set in production environment
      # Examples (set these in your production environment):
      # - NEWS_API_KEY=${NEWS_API_KEY}
      # - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID}
      # - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET}
      # - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - NODE_ENV=production
      - LOG_LEVEL=INFO
    
    # Use named volumes instead of bind mounts
    volumes:
      - output_data:/app/container_output
      - container_log_data:/app/logs
      - config_data:/app/config:ro
    
    # Production resource limits
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    
    # More frequent health checks for production
    healthcheck:
      test: ["CMD", "/usr/local/bin/docker-entrypoint.sh", "test"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 90s
    
    # Production logging
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
    
    # Security hardening
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m
    
    # Network mode
    network_mode: "bridge"

# Production volumes with specific drivers
volumes:
  output_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/docker/volumes/stock-sentiment-output
  
  container_log_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/docker/volumes/stock-sentiment-logs
  
  config_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/docker/volumes/stock-sentiment-config

networks:
  default:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: stock-sentiment-net