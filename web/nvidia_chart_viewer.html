<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Stock Sentiment & Price Charts</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #1e1e1e;
      color: #ffffff;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .stock-section {
      margin-bottom: 40px;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 20px;
      background-color: #2a2e39;
    }
    
    .stock-title {
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: bold;
    }
    
    .chart-container {
      width: 100%;
      height: 400px;
      background-color: #131722;
      border-radius: 8px;
      margin-bottom: 20px;
      position: relative;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .btn {
      background-color: #2962ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    
    .btn:hover {
      background-color: #1e53e5;
    }
    
    .btn:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    
    .info-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .info-card {
      background-color: #2a2e39;
      padding: 20px;
      border-radius: 8px;
    }
    
    .info-card h3 {
      margin: 0 0 10px 0;
      color: #2962ff;
    }
    
    .legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-color {
      width: 20px;
      height: 3px;
      border-radius: 2px;
    }
    
    .price-legend { background-color: #2962ff; }
    .sentiment-legend { background-color: #26a69a; }
    
    .status {
      text-align: center;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    
    .status.loading {
      background-color: #ffa726;
      color: #000;
    }
    
    .status.error {
      background-color: #ef5350;
    }
    
    .status.success {
      background-color: #26a69a;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .chart-container {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Multi-Stock Sentiment & Price Analysis</h1>
      <p>Interactive charts powered by TradingView Lightweight Charts</p>
    </div>
    
    <div id="status" class="status loading">Loading chart data...</div>
    
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color price-legend"></div>
        <span>Stock Price (USD)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color sentiment-legend"></div>
        <span>Sentiment Score (1-10)</span>
      </div>
    </div>
    
    <div class="controls">
      <button class="btn" onclick="refreshAllData()">Refresh All Data</button>
      <button class="btn" onclick="resetAllZoom()">Reset All Zoom</button>
    </div>

    <!-- NVIDIA Section -->
    <div class="stock-section">
      <div class="stock-title" style="color: #76b900;">NVIDIA (NVDA)</div>
      <div id="nvidiaChartContainer" class="chart-container"></div>
    </div>

    <!-- Apple Section -->
    <div class="stock-section">
      <div class="stock-title" style="color: #a6a6a6;">Apple (AAPL)</div>
      <div id="appleChartContainer" class="chart-container"></div>
    </div>

    <!-- Intel Section -->
    <div class="stock-section">
      <div class="stock-title" style="color: #0071c5;">Intel (INTC)</div>
      <div id="intelChartContainer" class="chart-container"></div>
    </div>
    
    <div class="info-panel">
      <div class="info-card">
        <h3>Latest Data Points</h3>
        <div id="latestData">Loading...</div>
      </div>
      <div class="info-card">
        <h3>Chart Statistics</h3>
        <div id="chartStats">Loading...</div>
      </div>
      <div class="info-card">
        <h3>Data Sources</h3>
        <div>
          <strong>Files:</strong> nvidia/apple/intel_score_price_dump.txt<br>
          <strong>Format:</strong> CSV (timestamp, score, price)<br>
          <strong>Last Updated:</strong> <span id="lastUpdated">Loading...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- TradingView Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    // Test if library loaded
    window.addEventListener('load', function() {
      console.log('Page loaded, TradingView available:', typeof LightweightCharts !== 'undefined');
      if (typeof LightweightCharts === 'undefined') {
        document.getElementById('status').innerHTML = 'Error: TradingView library failed to load from CDN';
        document.getElementById('status').className = 'status error';
      }
    });
  </script>
  
  <script>
    // Multi-chart configuration
    const stocks = ['nvidia', 'apple', 'intel'];
    const stockColors = {
      nvidia: { price: '#76b900', sentiment: '#26a69a' },
      apple: { price: '#a6a6a6', sentiment: '#ff9800' },
      intel: { price: '#0071c5', sentiment: '#e91e63' }
    };
    
    let charts = {};
    let chartData = {};
    
    // Initialize charts for all stocks
    function initCharts() {
      console.log('Initializing chart...');
      console.log('LightweightCharts available:', typeof LightweightCharts !== 'undefined');
      
      const chartContainer = document.getElementById('chartContainer');
      console.log('Chart container found:', !!chartContainer);
      
      if (typeof LightweightCharts === 'undefined') {
        updateStatus('error', 'TradingView Lightweight Charts library not loaded');
        return;
      }
      
      chart = LightweightCharts.createChart(chartContainer, {
        width: chartContainer.clientWidth,
        height: 500,
        layout: {
          backgroundColor: '#131722',
          textColor: 'rgba(255, 255, 255, 0.9)',
          fontFamily: "'Roboto', -apple-system, BlinkMacSystemFont, sans-serif",
        },
        grid: {
          vertLines: {
            color: 'rgba(197, 203, 206, 0.15)',
            style: 1, // Solid line
          },
          horzLines: {
            color: 'rgba(197, 203, 206, 0.15)',
            style: 1, // Solid line
          },
        },
        crosshair: {
          mode: LightweightCharts.CrosshairMode.Normal,
          vertLine: {
            color: 'rgba(224, 227, 235, 0.5)',
            width: 1,
            style: 2, // Dashed line
          },
          horzLine: {
            color: 'rgba(224, 227, 235, 0.5)',
            width: 1,
            style: 2, // Dashed line
          },
        },
        rightPriceScale: {
          borderColor: 'rgba(197, 203, 206, 0.8)',
          scaleMargins: {
            top: 0.1,
            bottom: 0.1,
          },
          autoScale: true, // Re-enable auto-scale
          visible: true,
          borderVisible: true,
          textColor: 'rgba(255, 255, 255, 0.9)',
          entireTextOnly: false,
        },
        leftPriceScale: {
          borderColor: 'rgba(197, 203, 206, 0.8)',
          scaleMargins: {
            top: 0.1,
            bottom: 0.1,
          },
          visible: true,
          autoScale: true, // Re-enable auto-scale
          borderVisible: true,
          textColor: 'rgba(255, 255, 255, 0.9)',
          entireTextOnly: false,
        },
        timeScale: {
          borderColor: 'rgba(197, 203, 206, 0.8)',
          timeVisible: true,
          secondsVisible: true, // Show seconds for more precision
          barSpacing: 75, // Increase spacing between bars for better visibility
          minBarSpacing: 30, // Minimum spacing to prevent overcrowding
          rightOffset: 50, // More padding on the right
          borderVisible: true,
          drawTicks: true,
          textColor: 'rgba(255, 255, 255, 0.8)',
        },
      });

      // Add price series (right scale) - Using Area series for better visibility
      priceSeries = chart.addAreaSeries({
        lineColor: '#2962ff',
        topColor: 'rgba(41, 98, 255, 0.2)',
        bottomColor: 'rgba(41, 98, 255, 0.05)',
        lineWidth: 3,
        title: 'NVIDIA Price (USD)',
        priceScaleId: 'right',
        priceFormat: {
          type: 'price',
          precision: 2,
          minMove: 0.01,
        },
      });

      // Add sentiment series (left scale) - Using Line series for clearer sentiment display
      sentimentSeries = chart.addLineSeries({
        color: '#26a69a',
        lineWidth: 4,
        title: 'Sentiment Score (1-10)',
        priceScaleId: 'left',
        priceFormat: {
          type: 'price',
          precision: 1,
          minMove: 0.1,
        },
      });

      console.log('Chart series created - priceSeries:', !!priceSeries, 'sentimentSeries:', !!sentimentSeries);

      // Make chart responsive
      window.addEventListener('resize', () => {
        chart.applyOptions({ width: chartContainer.clientWidth });
      });
    }

    // Load and parse CSV data from API or embedded fallback
    async function loadChartData() {
      try {
        console.log('Loading chart data...');
        updateStatus('loading', 'Loading chart data...');
        
        let csvText;
        
        // Try to fetch from API first
        try {
          const response = await fetch('/api/data');
          if (response.ok) {
            csvText = await response.text();
            console.log('CSV data loaded from API:', csvText);
          } else {
            throw new Error('API not available');
          }
        } catch (apiError) {
          // Fallback to embedded data
          console.log('Using embedded data fallback');
          csvText = `timestamp,score,price
2025-07-29T21:55:51.595416,8.0,175.51175
2025-07-29T22:53:07.703816,7.2,175.51175`;
        }
        const lines = csvText.trim().split('\n');
        
        if (lines.length < 2) {
          throw new Error('No data found in CSV file');
        }
        
        // Skip header row
        const dataLines = lines.slice(1);
        const priceData = [];
        const sentimentData = [];
        
        for (const line of dataLines) {
          const [timestamp, score, price] = line.split(',');
          
          if (!timestamp || !score || !price) continue;
          
          // Convert ISO timestamp to Unix timestamp for TradingView
          const date = new Date(timestamp);
          const time = Math.floor(date.getTime() / 1000);
          
          priceData.push({
            time: time,
            value: parseFloat(price)
          });
          
          sentimentData.push({
            time: time,
            value: parseFloat(score)
          });
        }
        
        // Sort by time (just in case)
        priceData.sort((a, b) => a.time - b.time);
        sentimentData.sort((a, b) => a.time - b.time);
        
        // Update chart (with error checking)
        if (!priceSeries || !sentimentSeries) {
          throw new Error('Chart series not properly initialized');
        }
        
        priceSeries.setData(priceData);
        sentimentSeries.setData(sentimentData);
        
        // Apply optimal spacing and zoom for better visibility
        const optimalSpacing = Math.max(100, 400 / priceData.length);
        chart.timeScale().applyOptions({
          barSpacing: optimalSpacing,
          rightOffset: 50,
        });
        
        // Fit content to show all data points clearly
        setTimeout(() => {
          chart.timeScale().fitContent();
        }, 100);
        
        // Store data for statistics
        chartData = { priceData, sentimentData };
        
        updateStatus('success', `Chart loaded successfully with ${priceData.length} data points`);
        updateStatistics();
        document.getElementById('exportBtn').disabled = false;
        
        // Auto-hide success message after 3 seconds
        setTimeout(() => {
          document.getElementById('status').style.display = 'none';
        }, 3000);
        
      } catch (error) {
        console.error('Error loading chart data:', error);
        updateStatus('error', `Error loading data: ${error.message}`);
      }
    }

    // Update status message
    function updateStatus(type, message) {
      const statusEl = document.getElementById('status');
      statusEl.className = `status ${type}`;
      statusEl.textContent = message;
      statusEl.style.display = 'block';
    }

    // Update statistics panel
    function updateStatistics() {
      if (!chartData.priceData || !chartData.sentimentData) return;
      
      const latestPrice = chartData.priceData[chartData.priceData.length - 1];
      const latestSentiment = chartData.sentimentData[chartData.sentimentData.length - 1];
      
      // Latest data
      document.getElementById('latestData').innerHTML = `
        <strong>Price:</strong> $${latestPrice.value.toFixed(2)}<br>
        <strong>Sentiment:</strong> ${latestSentiment.value.toFixed(1)}/10<br>
        <strong>Time:</strong> ${new Date(latestPrice.time * 1000).toLocaleString()}
      `;
      
      // Statistics
      const prices = chartData.priceData.map(d => d.value);
      const sentiments = chartData.sentimentData.map(d => d.value);
      
      const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
      const avgSentiment = sentiments.reduce((a, b) => a + b, 0) / sentiments.length;
      const maxPrice = Math.max(...prices);
      const minPrice = Math.min(...prices);
      
      document.getElementById('chartStats').innerHTML = `
        <strong>Avg Price:</strong> $${avgPrice.toFixed(2)}<br>
        <strong>Price Range:</strong> $${minPrice.toFixed(2)} - $${maxPrice.toFixed(2)}<br>
        <strong>Avg Sentiment:</strong> ${avgSentiment.toFixed(1)}/10<br>
        <strong>Data Points:</strong> ${chartData.priceData.length}
      `;
      
      document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
    }

    // Control functions
    function refreshData() {
      loadChartData();
    }

    function resetZoom() {
      if (!chartData.priceData || chartData.priceData.length === 0) return;
      
      // Apply optimal spacing for the current dataset
      const optimalSpacing = Math.max(100, 400 / chartData.priceData.length);
      chart.timeScale().applyOptions({
        barSpacing: optimalSpacing,
        rightOffset: 50,
      });
      
      // Fit content after applying spacing
      setTimeout(() => {
        chart.timeScale().fitContent();
      }, 50);
    }

    function exportChart() {
      // This is a placeholder - actual export functionality would require additional setup
      alert('Export functionality coming soon!');
    }

    // Auto-refresh functionality
    let refreshInterval;
    
    function startAutoRefresh() {
      // Refresh data every 30 seconds
      refreshInterval = setInterval(() => {
        loadChartData();
      }, 30000);
    }
    
    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    // Initialize chart when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initChart();
      // Add a small delay to ensure chart is fully initialized
      setTimeout(() => {
        loadChartData();
        startAutoRefresh(); // Start auto-refresh
      }, 100);
    });
  </script>
</body>
</html>